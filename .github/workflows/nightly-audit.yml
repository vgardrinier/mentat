name: Nightly Code Audit

on:
  schedule:
    # Runs at 2 AM UTC every day
    - cron: "0 2 * * *"
  workflow_dispatch: # Allows manual trigger for testing

jobs:
  check-activity:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}
      changed_files: ${{ steps.check.outputs.changed_files }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 100 # Need recent history to check last 24h (reduced from full history)

      - name: Check for commits in last 24 hours
        id: check
        run: |
          # Get commits from last 24 hours
          COMMITS=$(git log --since="24 hours ago" --oneline)

          if [ -z "$COMMITS" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "changed_files=" >> $GITHUB_OUTPUT
            echo "No commits in last 24 hours - skipping audit"
          else
            # Get the commit SHA from 24 hours ago
            BASE_COMMIT=$(git log --until="24 hours ago" --format="%H" -n 1)

            # If no commit from 24h ago, compare with first commit from today
            if [ -z "$BASE_COMMIT" ]; then
              BASE_COMMIT=$(git log --reverse --since="24 hours ago" --format="%H" -n 1)
            fi

            # Get list of changed files (excluding node_modules, lock files)
            CHANGED_FILES=$(git diff --name-only $BASE_COMMIT HEAD | \
              grep -v "node_modules" | \
              grep -v "package-lock.json" | \
              grep -v "yarn.lock" | \
              grep -v ".next/" | \
              tr '\n' ',' || echo "")

            echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT

            # Early exit if no relevant files changed
            if [ -z "$CHANGED_FILES" ]; then
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "Commits found but no relevant files changed (only node_modules, lock files, etc.)"
            else
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "Found commits in last 24h"
              echo "Changed files: $CHANGED_FILES"
            fi
          fi

  audit:
    needs: check-activity
    if: needs.check-activity.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1 # Only need current state for analysis

      - name: Run incremental code audit
        id: audit
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            # Incremental Nightly Code Audit

            ## CRITICAL: Incremental Analysis Only
            You are analyzing ONLY the files changed in the last 24 hours, not the entire codebase.

            Changed files: ${{ needs.check-activity.outputs.changed_files }}

            ## Your Task

            Analyze these changed files for technical debt and issues. Categorize findings into:

            ### AUTO-FIXABLE (Create PR immediately)
            Safe changes that can be automated:
            - Unused imports or exports
            - Dead code (unreferenced functions/variables)
            - Console.log statements left in production code
            - Missing/incorrect TypeScript types
            - Outdated comments referencing deleted code
            - Formatting inconsistencies

            **If you find auto-fixable issues:**
            1. Create branch: `cron/auto-fix-$(date +%Y-%m-%d)`
            2. Make the fixes
            3. Run `npm run lint` to verify
            4. Commit with clear message
            5. Push branch
            6. Create PR with:
               - Title: "ðŸ¤– Auto-fix: [brief description]"
               - Body: Detailed list of changes made
               - Label: "bot-created", "auto-fix"

            **IMPORTANT LIMITS:**
            - Max 20 files changed per PR
            - If more issues found, create multiple PRs or combine into issue

            ### NEEDS HUMAN REVIEW (Create GitHub Issue)
            Complex issues requiring decisions:
            - Architecture violations (check against docs/ARCHITECTURE.md)
            - Circular dependencies
            - Performance concerns
            - Security vulnerabilities
            - Code duplication that needs refactoring
            - Missing error handling

            **If you find complex issues:**
            1. Create GitHub issue with:
               - Title: "ðŸ” Code Review: [brief description]"
               - Label: "technical-debt", "needs-review"
               - Body:
                 - Problem description
                 - Affected files (with line numbers)
                 - Suggested approach to fix
                 - Estimated effort (S/M/L)

            ## Rules
            - ONLY analyze changed files, not entire codebase
            - Don't create PR if no auto-fixable issues found
            - Don't create issue if no complex problems found
            - If nothing to report, just say "No issues found" and exit
            - Branch prefix MUST be `cron/` not `bot/`

          claude_args: "--model sonnet"

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Nightly Audit Failed',
              body: `The nightly code audit workflow failed. Check the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`,
              labels: ['automation', 'bug']
            });

  report:
    needs: [check-activity, audit]
    if: always() # Always run to provide visibility
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Post audit summary
        uses: actions/github-script@v7
        with:
          script: |
            const hasChanges = '${{ needs.check-activity.outputs.has_changes }}';
            const auditStatus = '${{ needs.audit.result }}';
            const changedFiles = '${{ needs.check-activity.outputs.changed_files }}';

            let emoji, title, body;

            if (hasChanges === 'false') {
              emoji = 'ðŸ’¤';
              title = 'Nightly Audit: No Changes';
              body = 'No relevant code changes detected in the last 24 hours. Audit skipped.';
            } else if (auditStatus === 'success') {
              emoji = 'âœ…';
              title = 'Nightly Audit: Clean';
              body = `Analyzed changes from the last 24 hours. No issues found.\n\n**Files analyzed:** ${changedFiles.split(',').filter(f => f).length}`;
            } else if (auditStatus === 'failure') {
              emoji = 'ðŸš¨';
              title = 'Nightly Audit: Failed';
              body = 'The audit encountered an error. Check the workflow run for details.';
            } else {
              emoji = 'â­ï¸';
              title = 'Nightly Audit: Skipped';
              body = 'The audit was skipped.';
            }

            // Check if there's already an open audit summary issue from today
            const today = new Date().toISOString().split('T')[0];
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'audit-summary',
              state: 'open'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes(today) && issue.title.includes('Nightly Audit Summary')
            );

            if (existingIssue) {
              // Close the existing issue and add final comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `${emoji} **${title}**\n\n${body}\n\n[View workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                state: 'closed'
              });
            } else {
              // Only create issue if there was activity or an error
              if (hasChanges === 'true' || auditStatus === 'failure') {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `${emoji} Nightly Audit Summary - ${today}`,
                  body: `${body}\n\n[View workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                  labels: ['audit-summary', 'automation']
                });
              }
            }
